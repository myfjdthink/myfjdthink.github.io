(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{623:function(e,t,r){"use strict";r.r(t);var s=r(2),o=Object(s.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"使用-docker-搭建-wordpress-支持-https"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-docker-搭建-wordpress-支持-https"}},[e._v("#")]),e._v(" 使用 Docker 搭建 WordPress 支持 https")]),e._v(" "),t("p",[e._v("最近把 WordPress 迁移到了腾讯云，为了配置方便使用了 docker 来运行，这里记录下配置过程")]),e._v(" "),t("h2",{attrs:{id:"准备-compose-文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备-compose-文件"}},[e._v("#")]),e._v(" 准备 compose 文件")]),e._v(" "),t("p",[e._v("WordPress 的 "),t("a",{attrs:{href:"https://docs.docker.com/compose/wordpress/#define-the-project",target:"_blank",rel:"noopener noreferrer"}},[e._v("docker compose 文件"),t("OutboundLink")],1),e._v("网上有很多，需要一个 mysql 的镜像，还有 WordPress 的镜像，大概长这样：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("version: '3'services:   db:     image: mysql:5.7     volumes:       - db_data:/var/lib/mysql     restart: always     environment:       MYSQL_ROOT_PASSWORD: somewordpress       MYSQL_DATABASE: wordpress       MYSQL_USER: wordpress       MYSQL_PASSWORD: wordpress   wordpress:     depends_on:       - db     image: wordpress:latest     ports:       - \"8000:80\"     restart: always     environment:       WORDPRESS_DB_HOST: db:3306       WORDPRESS_DB_USER: wordpress       WORDPRESS_DB_PASSWORD: wordpressvolumes:    db_data:\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h2",{attrs:{id:"定制-dockerfile-添加-https-支持"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#定制-dockerfile-添加-https-支持"}},[e._v("#")]),e._v(" 定制 Dockerfile 添加 https 支持")]),e._v(" "),t("p",[e._v("借助于 letsencrypt 这个项目， 给个人网站添加 letsencrypt 变得十分容易，详细见这篇文章：")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://coolshell.cn/articles/18094.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("如何免费的让网站启用HTTPS"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("大概流程就是安装一个软件包 letsencrypt ，然后配置你的网站信息即可，但是我们的 WordPress 是安装在 docker 里面，所以我们要想办法把这个软件包打进镜像里面。")]),e._v(" "),t("p",[e._v("接下来我们要对 WordPress 这个镜像进行自定义，参考这篇文章：")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://breeto.id.au/2017/03/docker-wordpress-letsencrypt/",target:"_blank",rel:"noopener noreferrer"}},[e._v("docker + wordpress + letsencrypt"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("先定制 Dockerfile，集成 letsencrypt")]),e._v(" "),t("p",[e._v("新建文件夹 wordpress_tls 添加 Dockerfile")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('FROM wordpress:php7.1RUN echo "export TERM=xterm LANG=en_US.UTF-8" >> ~/.bashrc \\    && apt-get update && apt-get -y install git \\    && rm -rf "/opt/letsencrypt" \\    && git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt \\    && cd /opt/letsencrypt \\    && ./letsencrypt-auto --version\n')])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("wordpress 官方镜像使用的 ubuntu 源是国外源，打包镜像的速度会让你怀疑人生。可以把宿主机的 ubuntu 源放进 docker 镜像里。")]),e._v(" "),t("p",[t("code",[e._v("$cp /etc/apt/sources.list ./")])]),e._v(" "),t("p",[e._v("修改 Dockerfile")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('FROM wordpress:php7.1ADD sources.list /etc/apt/sources.listRUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys \\    && apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3B4FE6ACC0B21F32 // 改成你的 keyRUN echo "export TERM=xterm LANG=en_US.UTF-8" >> ~/.bashrc \\    && apt-get update && apt-get -y install git \\    && rm -rf "/opt/letsencrypt" \\    && git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt \\    && cd /opt/letsencrypt \\    && ./letsencrypt-auto --version\n')])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("添加新的源会有认证的问题，可以参考 "),t("a",{attrs:{href:"http://naveenubuntu.blogspot.com/2011/08/fixing-gpg-keys-in-ubuntu.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://naveenubuntu.blogspot.com/2011/08/fixing-gpg-keys-in-ubuntu.html"),t("OutboundLink")],1),e._v(" 解决")]),e._v(" "),t("h2",{attrs:{id:"配置-https"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置-https"}},[e._v("#")]),e._v(" 配置 https")]),e._v(" "),t("p",[e._v("启动容器：")]),e._v(" "),t("p",[t("code",[e._v("$docker-compose up -d")])]),e._v(" "),t("p",[e._v("然后配置 https")]),e._v(" "),t("p",[t("code",[e._v("$docker-compose exec wordpress_tls /opt/letsencrypt/certbot-auto --apache -d your.domain.com --agree-tos -n -m you@your.domain.com")])]),e._v(" "),t("p",[e._v("Let’s Encrypt 的证书90天就过期了，过期后执行")]),e._v(" "),t("p",[t("code",[e._v("$ docker-compose exec wordpress_tls /opt/letsencrypt/certbot-auto renew")])]),e._v(" "),t("p",[e._v("来更新，可以把更新脚本写进 crontab")]),e._v(" "),t("p",[t("code",[e._v("$crontab -e")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("0 0 1 * * docker-compose exec wordpress_tls /opt/letsencrypt/certbot-auto renew\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h2",{attrs:{id:"完整示例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#完整示例"}},[e._v("#")]),e._v(" 完整示例")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/myfjdthink/docker-wordpress",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/myfjdthink/docker-wordpress"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=o.exports}}]);