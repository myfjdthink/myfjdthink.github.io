(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{427:function(e,t,s){e.exports=s.p+"assets/img/ken_die.7958de4a.jpg"},428:function(e,t,s){e.exports=s.p+"assets/img/-1461308934571.0f3215bb.png"},606:function(e,t,s){"use strict";s.r(t);var n=s(2),a=Object(n.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"单独测试-waterline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单独测试-waterline"}},[e._v("#")]),e._v(" 单独测试 waterline")]),e._v(" "),t("h1",{attrs:{id:"单独测试-waterline-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单独测试-waterline-2"}},[e._v("#")]),e._v(" 单独测试 waterline")]),e._v(" "),t("p",[e._v("本文主旨：更简单更快速地测试 sails Model 操作。")]),e._v(" "),t("p",[e._v("waterline 是 sails 里使用的 orm 工具。")]),e._v(" "),t("p",[e._v("sails 官方提供了 mocha 的测试例子 "),t("a",{attrs:{href:"http://sailsjs.org/documentation/concepts/testing",target:"_blank",rel:"noopener noreferrer"}},[e._v("Testing | Sails.js Documentation"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("其原理主要是在 mocha 启动之前，先启动 sails，这样全局变量 sails 以及全局 Model 、Service 对象就生成了，之后就可以针对 sails 的功能进行测试了。")]),e._v(" "),t("p",[e._v("在 test 目录的 bootstrap.test.js 添加如下代码：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("var sails = require('sails');before(function(done) {  // Increase the Mocha timeout so that Sails has enough time to lift.  this.timeout(5000);  sails.lift({    // configuration for testing purposes  }, function(err, server) {    if (err) return done(err);    // here you can load fixtures, etc.    done(err, sails);  });});after(function(done) {  // here you can clear fixtures, etc.  sails.lower(done);});\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("看起来很简单对不对。")]),e._v(" "),t("p",[e._v("是很简单，但是，用过 sails 的童鞋有清楚，项目稍微大一点的时候，sails 的启动速度有点慢，假设你只是想测试一个 model 的一个简单操作，你还是需要启动整个 sails。每次操作你都需要等待几十秒的时间。。。")]),e._v(" "),t("p",[e._v("国外某位童鞋还专门吐槽了这个事情：")]),e._v(" "),t("ul",[t("li",[e._v("sails 测试慢成狗啦 "),t("a",{attrs:{href:"https://kev.inburke.com/kevin/node-require-is-dog-slow/",target:"_blank",rel:"noopener noreferrer"}},[e._v("node-require-is-dog-slow"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("吐槽 sails 和 waterline 的各种问题 "),t("a",{attrs:{href:"https://kev.inburke.com/kevin/dont-use-sails-or-waterline/",target:"_blank",rel:"noopener noreferrer"}},[e._v("dont-use-sails-or-waterline"),t("OutboundLink")],1),e._v("\n好吧，这个问题的确是存在的，那要怎么解决呢，如果尝试把对 controller 和 service（操作数据库）的测试分开，那么在测试 service 的时候只加载 orm 会不会快一点呢？来试一试吧。")])]),e._v(" "),t("h2",{attrs:{id:"单独加载-waterline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单独加载-waterline"}},[e._v("#")]),e._v(" 单独加载 waterline")]),e._v(" "),t("h3",{attrs:{id:"相关文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#相关文档"}},[e._v("#")]),e._v(" 相关文档")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("waterline 的官方文档提供了 "),t("a",{attrs:{href:"https://github.com/balderdashy/waterline-docs/blob/master/introduction/getting-started.md",target:"_blank",rel:"noopener noreferrer"}},[e._v(" getting started 示例"),t("OutboundLink")],1),e._v("\n比较简单，示例里连接的是内存数据库，没有提供怎么配置连接 mongo 的信息。")])]),e._v(" "),t("li",[t("p",[e._v("sails 的人员也提供了一个 Express 里使用 waterline 的示例 "),t("a",{attrs:{href:"https://gist.github.com/mikermcneil/8443381",target:"_blank",rel:"noopener noreferrer"}},[e._v("Waterline v0.10 Express Example.js"),t("OutboundLink")],1),e._v("\n跟上一个例子同样的问题，还是没讲怎么配置 mongo。")])])]),e._v(" "),t("p",[t("img",{attrs:{src:s(427),alt:"ken_die.jpg"}})]),e._v(" "),t("h3",{attrs:{id:"自己实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自己实现"}},[e._v("#")]),e._v(" 自己实现")]),e._v(" "),t("p",[e._v("既然网上的例子不靠谱，那么就去扒 sails 的源码吧。")]),e._v(" "),t("p",[e._v("让我们小心翼翼地打开 node_module 下的 sails 目录")]),e._v(" "),t("p",[t("img",{attrs:{src:s(428),alt:"-1461308934571.png"}})]),e._v(" "),t("p",[e._v("额，好直接，文件名已经告诉我们 waterline 是在哪里初始化的了。点进去看看吧。")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("module.exports = function howto_buildORM(sails) {  return function buildORM(modelDefs, cb) {    // 来自 Nick 注释 这里拿到项目的定义的 Model 然后逐个 waterline.loadCollection    // -> Instantiate ORM in memory.    // -> Iterate through each model definition:    //    -> Create a proper Waterline Collection for each model    //    -> then register it w/ the ORM.    sails.log.verbose('Starting ORM...');    var waterline = new Waterline();    _.each(modelDefs, function loadModelsIntoWaterline(modelDef, modelID) {      sails.log.silly('Registering model `' + modelID + '` in Waterline (ORM)');      waterline.loadCollection(Waterline.Collection.extend(modelDef));    });    // 来自 Nick 注释 拿系统配置的 connections    // Find all the connections used    var connections = _.reduce(sails.adapters, function getConnectionsInPlay(connections, adapter, adapterKey) {      _.each(sails.config.connections, function(connection, connectionKey) {        if (adapterKey === connection.adapter) {          connections[connectionKey] = connection;        }      });      //console.log('connections', connections);      return connections;    }, {});    var appDefaults = sails.config.models;    // -> \"Initialize\" ORM    //    : This performs tasks like managing the schema across associations,    //    : hooking up models to their connections, and auto-migrations.    waterline.initialize({      adapters: sails.adapters,      connections: connections,      defaults: appDefaults    }, function (err, orm) {      if (err) return cb(err);      var models = orm.collections || [];      _.each(models, function eachInstantiatedModel(thisModel, modelID) {        // 来自 Nick 注释 这个操作不能省        _.bindAll(thisModel);        ......        ......        ......        ......        sails.models[modelID] = thisModel;        // 配置全局 Models        if (sails.config.globals && sails.config.globals.models) {          var globalName = sails.models[modelID].globalId || sails.models[modelID].identity;          global[globalName] = thisModel;        }      });      cb();    });  };};\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("吧啦吧啦一大堆，从这源码可以得到两个关键的信息，")]),e._v(" "),t("ol",[t("li",[e._v("要先把 api/model 里定义的 models 都 load into waterline。")]),e._v(" "),t("li",[e._v("waterline.initialize 的时候需要3个参数：")])]),e._v(" "),t("ul",[t("li",[e._v("adapters: 也就是那个 ‘sails-mongo’")]),e._v(" "),t("li",[e._v("connections: mongo 连接的配置信息")]),e._v(" "),t("li",[e._v("defaults: 连接方式，就是 models.js 里配置的那个 migrate")])]),e._v(" "),t("h4",{attrs:{id:"load-models"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#load-models"}},[e._v("#")]),e._v(" load models")]),e._v(" "),t("p",[e._v("先解决第一个问题， load models，源码里暂时没看到怎么实现的，自己实现也不难：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v(" /** * require api/models 里面的每个对象 * @param connection 每个 models 配置的默认 connection * @returns {{}} */function getModelDefs(connection) {  console.log('Loading app models...');  let models = {};  let sourceFolder = process.cwd() + '/api/models';  let files = fs.readdirSync(sourceFolder);  for (let i = 0; i < files.length; i++) {    try {      if (files[i].includes('.js')) {        let model = require('../api/models/' + files[i]);        let identity = files[i].toLowerCase().replace('.js', '');        console.log('found model', identity);        model.identity = identity;        model.connection = connection;        models[identity] = model;      }    } catch (err) {      console.log('extend model err', err.stack || err);    }  }  return models}\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h4",{attrs:{id:"waterline-initialize"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#waterline-initialize"}},[e._v("#")]),e._v(" waterline initialize")]),e._v(" "),t("p",[e._v("好了，接下来是第二个问题 waterline initialize。")]),e._v(" "),t("ol",[t("li",[e._v("先拿到项目里的 /config/connections 配置：")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v(" /** * 读取系统的 connections 配置 * @param connectionName 指定的连接 * @returns {Object} */function getConnections(connectionName) {  let connections = require('../config/connections');  if (connectionName) {    let result = {};    result[connectionName] = connections.connections[connectionName];    return result  } else {    return connections.connections  }}\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("ol",[t("li",[e._v("准备完毕，调用 waterline.initialize")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("module.exports.buildORM = function (connectionName, appDefaults, cb) {  // -> Instantiate ORM in memory.  // -> Iterate through each model definition:  //    -> Create a proper Waterline Collection for each model  //    -> then register it w/ the ORM.  console.log('Starting ORM...');  if (!connectionName || !appDefaults) {    return cb('miss connectionName or appDefaults')  }  appDefaults.connection = connectionName;  let modelDefs = getModelDefs(connectionName);  let waterline = new Waterline();  _.each(modelDefs, function loadModelsIntoWaterline(modelDef, modelID) {    console.log('Registering model `' + modelID + '` in Waterline (ORM)');    waterline.loadCollection(Waterline.Collection.extend(modelDef));  });  // Find all the connections used  let connections = getConnections(connectionName);  let adapters = {    'sails-mongo': sailsMongoAdapter  };  console.log('buildORM appDefaults', appDefaults);  console.log('buildORM connections', connections);  console.log('buildORM adapters', Object.keys(adapters));  // -> \"Initialize\" ORM  //    : This performs tasks like managing the schema across associations,  //    : hooking up models to their connections, and auto-migrations.  waterline.initialize({    adapters: adapters,    connections: connections,    defaults: appDefaults  }, function (err, orm) {    if (err) return cb(err);    let models = orm.collections || [];    _.each(models, function eachInstantiatedModel(thisModel, modelID) {      // Bind context for models      // (this (breaks?)allows usage with tools like `async`)      _.bindAll(thisModel);    });    // Success    cb(null, models);  });};\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("搞定，这样 waterline 就启动完毕啦，默认加载 api/models 里定义的对象，加载 /config/connections 的里 DB 连接信息。")]),e._v(" "),t("h3",{attrs:{id:"在-mocha-里使用-waterline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#在-mocha-里使用-waterline"}},[e._v("#")]),e._v(" 在 Mocha 里使用 waterline")]),e._v(" "),t("h4",{attrs:{id:"初始化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#初始化"}},[e._v("#")]),e._v(" 初始化")]),e._v(" "),t("p",[e._v("在 test 目录的 bootstrap.test.js 添加如下代码：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("'use strict';let BuildWaterLine = require('../hack/BuildWaterLine');let _ = require('underscore');let start_time = Date.now()before(function (done) {  // Increase the Mocha timeout so that Sails has enough time to lift.  this.timeout(10000);  // Initialize Waterline  BuildWaterLine.buildORM('testMongodb', {migrate: 'drop'}, function (err, models) {    if (err) throw err;    console.log('buildORM models', Object.keys(models));    console.log('waterline init time %s s', (Date.now() - start_time) / 1000);    done();  })});after(function (done) {  done();  // here you can clear fixtures, etc.});\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("BuildWaterLine.buildORM 方法就是上文我们自定义的加载方法，该方法返回的 models 就是每个带查询方法的 model 对象啦。")]),e._v(" "),t("h4",{attrs:{id:"怎么调用-model-方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#怎么调用-model-方法"}},[e._v("#")]),e._v(" 怎么调用 Model 方法")]),e._v(" "),t("p",[e._v("上面只是返回了 models 对象，怎么在 mocha 的测试文件里使用到这些对象呢，两个方法。")]),e._v(" "),t("ol",[t("li",[e._v("全局化，跟 sails 那样")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v(" _.each(models, function eachInstantiatedModel(thisModel, modelID) {     global[modelID] = thisModel; });\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("需要注意 modelID 的大小写问题哦。把每个 Model 都全局化之后，就可以直接在 mocha 直接调用啦。")]),e._v(" "),t("ol",[t("li",[e._v("拓展到其他对象上")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("var _ = require('lodash');let UserDao = require('../dao/UserDao')_.extend(UserDao, models['user']);\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("lodash 的 extend 提供了对象拓展功能。上文的代码把 user 这个 Model 的方法拓展到了 UserDao 对象上。")]),e._v(" "),t("p",[e._v("或者你可以将 Model 拓展到 api/models 里的同名对象。这话听起来是不是很奇怪？这里有个细节你需要了解：")]),e._v(" "),t("p",[t("strong",[e._v("sails 里全局的 Model 对象，例如 User ，和你在 api/models/User.js 对象是不一样的哦")])]),e._v(" "),t("p",[e._v("至于为什么，你自己去 Google 吧。")]),e._v(" "),t("p",[e._v("做好拓展后，在测试文件里你只需要这样引入")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("let UserDao = require('......../UserDao');UserDao.create({phone: '13848965325'}, (err, cUser) => {   should.exist(cUser);   done(err)})\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h2",{attrs:{id:"结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结果"}},[e._v("#")]),e._v(" 结果")]),e._v(" "),t("p",[e._v("单独加载 waterline 耗时")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("waterline init time 0.532 s\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("sails 启动耗时")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("sails start time 3.122 s\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("这个对比结果是基于新建的 sails 项目，只有4个 Model 文件。")]),e._v(" "),t("h2",{attrs:{id:"源码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#源码"}},[e._v("#")]),e._v(" 源码")]),e._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/myfjdthink/CodeNode/tree/master/sails/waterline_init",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://github.com/myfjdthink/CodeNode/tree/master/sails/waterline_init"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=a.exports}}]);