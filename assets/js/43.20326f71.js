(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{539:function(s,a,t){s.exports=t.p+"assets/img/pyspark_architecture.83495301.png"},657:function(s,a,t){"use strict";t.r(a);var n=t(2),r=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"koalas-是什么"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koalas-是什么"}},[s._v("#")]),s._v(" Koalas 是什么")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://koalas.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("koalas"),a("OutboundLink")],1),s._v(": pandas API on Apache Spark")]),s._v(" "),a("p",[s._v("这是 koalas 官网的描述，在 Spark 上的 pandas api.")]),s._v(" "),a("p",[s._v("pandas 具有非常庞大的用户基础，为了让这些用户顺利从 pandas 迁移到 Spark，就出现了 koalas。")]),s._v(" "),a("p",[s._v("pandas 只能分析单机能够处理的数据集, 对大数据束手无策，从另一个角度，你可以认为 koalas 是 pandas 的分布式实现。")]),s._v(" "),a("h2",{attrs:{id:"koalas-的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#koalas-的问题"}},[s._v("#")]),s._v(" Koalas 的问题")]),s._v(" "),a("p",[s._v("准确来说是 python udf 的问题，运行速度非常慢。")]),s._v(" "),a("p",[s._v("虽然 Spark 提供了 python api：pyspark，但是背后调用的还是 jvm，我们看看 架构图")]),s._v(" "),a("p",[a("img",{attrs:{src:t(539),alt:"pyspark_architecture.png"}})]),s._v(" "),a("p",[s._v("spark为了保证核心架构的统一性，在核心架构外围封装了一层python，spark的核心架构功能包括计算资源的申请，task的管理和分配， driver与executor之间的通信，executor之间的通信，rdd的载体等都是在基于JVM的。")]),s._v(" "),a("p",[s._v("pyspark 会先调起 jvm 进程，然后在 jvm 里再run python daemon 以运行 python udf（自定义函数），这里进程之间的通信开销是非常庞大的，\n虽然 spark 后面引入后 arrow 来减少数据序列化的开销，但是比起 java scala udf，还是有非常大的差距的")]),s._v(" "),a("h2",{attrs:{id:"性能测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#性能测试"}},[s._v("#")]),s._v(" 性能测试")]),s._v(" "),a("p",[s._v("我们做一个对比测试，先从数据库中读取 30w 条数据，spark 的大概配置是 1主2从，每个节点 8CUP+2G内存")]),s._v(" "),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[s._v("df_origin "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" spark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("read"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bigquery"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("option"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"filter"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"on_date > '2022-06-21' and on_date < '2022-06-30' \"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("load"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"db.table"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndf_price "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" df_origin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("select"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"on_date"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'token_address'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'price'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'token_symbol'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \\\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("where"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"chain = 'BSC' \"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\ndf_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"使用-koalas-对字段做-lower-操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-koalas-对字段做-lower-操作"}},[s._v("#")]),s._v(" 使用 koalas 对字段做 lower 操作")]),s._v(" "),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("upper_udf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'token_address_new'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" item"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'token_address'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("upper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" item\n\ndf_ks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("apply")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("upper_udf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" axis"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("head"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("将 token_address 字段做 upper 处理，执行时间大概是 14s")]),s._v(" "),a("h3",{attrs:{id:"使用-pyspark-sql-functions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-pyspark-sql-functions"}},[s._v("#")]),s._v(" 使用 pyspark.sql.functions")]),s._v(" "),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" pyspark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("functions "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" upper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("col\n\ndf_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("withColumn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"token_address_new"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("upper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("col"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"token_address"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("多次执行平均时间是 1s")]),s._v(" "),a("h3",{attrs:{id:"使用-spark-sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-spark-sql"}},[s._v("#")]),s._v(" 使用 spark sql")]),s._v(" "),a("div",{staticClass:"language-py line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-py"}},[a("code",[s._v("df_price"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("createOrReplaceTempView"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'token_price_daily'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nspark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("sql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'select *,lower(token_address) as token_address_new from token_price_daily'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("show"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("多次执行平均时间是 1s")]),s._v(" "),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("为什么 spark sql 会快那么多？")]),s._v(" "),a("p",[s._v("spark sql 会直接解析成 spark 的 rdd 操作，rdd 操作都在 jvm 内执行，没有和 python 程序的数据交互。")]),s._v(" "),a("p",[s._v("不是 spark sql 快，是 koalas 使用了 python udf，是 udf 执行太慢了。")]),s._v(" "),a("h2",{attrs:{id:"建议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建议"}},[s._v("#")]),s._v(" 建议")]),s._v(" "),a("p",[s._v("正因如此，我目前在设计 spark 代码架构时，优先推荐的方式是")]),s._v(" "),a("ul",[a("li",[s._v("spark.read 加载 dataframe")]),s._v(" "),a("li",[s._v("将 dataframe.createOrReplaceTempView() 注册 table")]),s._v(" "),a("li",[s._v("使用 sql 完成业务计算")]),s._v(" "),a("li",[s._v("必要情况下才使用 koalas udf，而且优先考虑 scala udf（编译好后通过 jar 包来引入）")])]),s._v(" "),a("p",[s._v("koalas udf 的唯一使用情况是：业务上必须使用 udf，而且没有人会写 java or scala。")]),s._v(" "),a("p",[s._v("如果你的业务足够简单，使用 SQL 就可以覆盖绝大部分情况，你还可以考虑 "),a("a",{attrs:{href:"https://github.com/dbt-labs/dbt-spark",target:"_blank",rel:"noopener noreferrer"}},[s._v("dbt-spark"),a("OutboundLink")],1),s._v(", dbt 使用了软件工程的思想来管理 sql。")]),s._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章"}},[s._v("#")]),s._v(" 参考文章")]),s._v(" "),a("p",[s._v("https://zhuanlan.zhihu.com/p/61665905\nhttps://www.mobvista.com/cn/blog/2019-12-27-2/")])])}),[],!1,null,null,null);a.default=r.exports}}]);