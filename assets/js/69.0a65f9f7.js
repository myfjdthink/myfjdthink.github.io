(window.webpackJsonp=window.webpackJsonp||[]).push([[69],{628:function(s,a,n){"use strict";n.r(a);var t=n(2),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"做个-sso-系统"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#做个-sso-系统"}},[s._v("#")]),s._v(" 做个 SSO 系统")]),s._v(" "),a("h3",{attrs:{id:"应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用场景"}},[s._v("#")]),s._v(" 应用场景")]),s._v(" "),a("p",[s._v("最近公司要统一内部管理系统的用户与权限控制，于是考虑开发一个 SSO 单点登陆系统，考虑到内部系统都是 web 服务和开发时间有限，而且内部系统都是 Node.js 写的， 使用 Koa 框架，最终决定使用最简单的解决方案。")]),s._v(" "),a("h3",{attrs:{id:"实现方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现方案"}},[s._v("#")]),s._v(" 实现方案")]),s._v(" "),a("h4",{attrs:{id:"原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),a("p",[s._v("kwt + cookie")]),s._v(" "),a("p",[s._v("JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息，这里将作为用户的登陆标识。")]),s._v(" "),a("p",[s._v("用户的登陆流程是这样的：")]),s._v(" "),a("ol",[a("li",[s._v("打开接入方系统，假设域名是 aaa.abc.com")]),s._v(" "),a("li",[s._v("校验登陆状态，查看 cookie 里是否存在 jwt 并解密校验，如果未登录，跳转到 SSO 登陆页面，SSO 域名是 sso.abc.com")]),s._v(" "),a("li",[s._v("在 SSO 登陆页面填写用户名和密码（未注册的先注册），登陆后 SSO 系统把 jwt 写入 cookie，cookie 的有效域名为 abc.com，然后跳跳转回原系统（跳过来的时候在 url 里带上原系统地址）")]),s._v(" "),a("li",[s._v("返回原系统，校验登陆状态，登陆完成")])]),s._v(" "),a("h4",{attrs:{id:"sso-系统实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sso-系统实现"}},[s._v("#")]),s._v(" sso 系统实现")]),s._v(" "),a("p",[s._v("基本的用户管理功能，有：")]),s._v(" "),a("ul",[a("li",[s._v("部门管理")]),s._v(" "),a("li",[s._v("权限管理")]),s._v(" "),a("li",[s._v("注册功能")]),s._v(" "),a("li",[s._v("登陆功能")]),s._v(" "),a("li",[s._v("找回密码\n重点功能是登陆，需要在登陆时将 jwt 写入 cookie，上文原理中有要求各个系统要有个共同的主域名 abc.com，各个系统不同域的话，那就只能把 jwt 在 url 中返回给原系统了，原系统自己把 jwt 写入 cookie，来看看这部分的代码：")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const jwtdata = {\n  username: user.username,\n  email: user.email,\n  role: user.role\n}\n// 生成 jwt\nconst token = jwt.sign(jwtdata, Const.TOKEN_SECRET, {expiresIn: '365d'})\n// 写入 cookie\nctx.cookies.set(\n  'token',\n  token,\n  {\n    domain: '.abc.com',        // 写cookie所在的域名\n    path: '/',                 // 写cookie所在的路径\n    maxAge: 30 * 60 * 1000,    // cookie有效时长\n    httpOnly: false,  // 是否只用于http请求中获取\n    overwrite: true  // 是否允许重写\n  }\n)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("注意用于加密 jwt 的密匙，内部系统的话可以直接用一个密匙加密，然后接入方都用这个密匙解密就可以了。")]),s._v(" "),a("p",[s._v("如果安全要求高一点，那就是 sso 系统用公钥（保密）加密 jwt，然后接入方使用私钥（公开）解密。")]),s._v(" "),a("h4",{attrs:{id:"接入方实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接入方实现"}},[s._v("#")]),s._v(" 接入方实现")]),s._v(" "),a("p",[s._v("考虑到接入方有多个，所以考虑直接写个 Koa 中间件给各个接入方调用是最简单的，将此中间件作为 npm 包发布，接入方使用该中间件监听所有请求，完成对 jwt 的解析和校验。")]),s._v(" "),a("p",[a("strong",[s._v("监控请求")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\nconst auth = require('sso-auth')\napp.use(auth.validate({\n  unless: [/\\/register/, /\\/login/, /\\/message/],\n  errHandle: async function (ctx) {\n    console.log('授权错误')\n    // 跳转到SSO的登陆页面或者 返回url给前端跳转\n    ctx.body = {\n      code: 3,\n      message: '授权错误',\n      url: 'https://sso.abc.com'\n    }\n    ctx.status = 200\n  }\n}))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[a("strong",[s._v("中间件 sso-auth 的内部实现")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 从 cookie 取出 jwt\n// 校验 jwt 是否符合\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("假设接入方是其他编程语言的系统，那就对该语言实现对应的上述校验逻辑即可。")]),s._v(" "),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("jwt 作为 token 可以附带额外的信息")]),s._v(" "),a("p",[s._v("使用 cookie 存储 token ，同域名的系统接入非常方便")]),s._v(" "),a("p",[s._v("使用中间件方便了接入方校验 token")])])}),[],!1,null,null,null);a.default=e.exports}}]);