(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{546:function(s,a,t){s.exports=t.p+"assets/img/dune_ui.78edc014.png"},664:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"dune-的前端体验"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dune-的前端体验"}},[s._v("#")]),s._v(" Dune 的前端体验")]),s._v(" "),a("p",[s._v("我们在 Dune 发起一个 query 请求，背后的系统是如何运行的？我们可以从前端的体验来推测一下, F12 打开浏览器控制台，观察 Network, 可以看到点击 run query 会触发多个异步查询请求，我们一个一个分析。\n"),a("img",{attrs:{src:t(546),alt:"img.png"}})]),s._v(" "),a("p",[s._v("可以看到所有请求访问的地址是 "),a("code",[s._v("https://core-hsr.duneanalytics.com/v1/graphql")]),s._v("\n从名字上可以看出和 graphql 有关，背后的服务是 "),a("a",{attrs:{href:"https://hasura.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("hasura"),a("OutboundLink")],1),s._v(", hasura 是开源的 graphql 服务，只需要配置好 database，就可以自动读取 table schema 并生成对应的 graphql 接口。")]),s._v(" "),a("p",[s._v("（怎么看出来是 hasura 的？刚好用过~）")]),s._v(" "),a("p",[s._v("接下来看第一个 request body，这是将用户写的 SQL 提到到数据库中")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"operationName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"UpsertQuery"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"variables"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"object"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1079250")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"dataset_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"New Query"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"select * from erc20_ethereum.evt_Approval where Date(evt_block_time) = '2022-07-21'\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"user_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56489")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"session_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("56489")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("第二个 request body, 告诉后端执行刚刚用户提交的 SQL，注意是通过 query_id 来定义一个 query 的，而且 sql query 是异步的。")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"operationName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ExecuteQuery"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"variables"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"query_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1079250")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"parameters"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("hasura 会调度一个 engine 来完成 sql query。不过会同步返回一个 job_id 给前端")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"data"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"execute_query"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"job_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6c1969e8-1398-48db-900d-6fd7ed5247df"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"__typename"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"execute_query_response"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("第三至 N 个 request body, 不断轮询后端（通过job_id），查看 sql 的执行状态")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"operationName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"GetQueuePosition"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"variables"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"job_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6c1969e8-1398-48db-900d-6fd7ed5247df"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("等后端返回 sql query 完成时，前端会发起取数请求")]),s._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"operationName"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"FindResultDataByJob"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"variables"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"job_id"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"6c1969e8-1398-48db-900d-6fd7ed5247df"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这样用户就看到了查询结果")]),s._v(" "),a("p",[s._v("OK 我们可以得到初步结论，Dune 的查询是异步式的，使用 hasura 来管理用户是 query 生命周期。")]),s._v(" "),a("h2",{attrs:{id:"查询引擎"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询引擎"}},[s._v("#")]),s._v(" 查询引擎")]),s._v(" "),a("p",[s._v("刚刚收到 hasura 会调度 engine 来完成 sql query，Dune V1 是直接用 Postgres 集群，后面性能更不上了，就出现了 "),a("a",{attrs:{href:"https://docs.dune.com/dune-engine-v2-beta/dunes-new-query-engine",target:"_blank",rel:"noopener noreferrer"}},[s._v("Dune Engine V2"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("从文档的介绍可知，V2 的 engine 是 “Instance of Apache Spark hosted on Databricks” ，托管在 Databricks 的 Spark 集群，SQL方言也改为了 DatabricksSQL。")]),s._v(" "),a("h3",{attrs:{id:"databrickssql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#databrickssql"}},[s._v("#")]),s._v(" "),a("a",{attrs:{href:"https://databricks.com/product/databricks-sql",target:"_blank",rel:"noopener noreferrer"}},[s._v("DatabricksSQL"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("和 Bigquery 类似，是一个 serverless sql 数据湖计算平台，而且也是 sql only, 不过背后跑的还是 Spark，可以看看这个 "),a("a",{attrs:{href:"https://www.youtube.com/watch?v=OMjxlqIqSqs&ab_channel=Databricks",target:"_blank",rel:"noopener noreferrer"}},[s._v("video"),a("OutboundLink")],1),s._v(" 快速了解下。")]),s._v(" "),a("p",[s._v("在 Dune 上实测，V2 的查询速度会比较慢，使用日期过滤查询 transactions 表，需要 1min 左右。")]),s._v(" "),a("p",[s._v("值得思考的是，几家区块链数据分析平台一致选择了这类 sql only 的数据湖方案")]),s._v(" "),a("ul",[a("li",[s._v("Nansen：Bigquery")]),s._v(" "),a("li",[s._v("Footprint：Bigquery")]),s._v(" "),a("li",[a("a",{attrs:{href:"https://flipsidecrypto.xyz/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Flipside"),a("OutboundLink")],1),s._v("：Snowflake")]),s._v(" "),a("li",[s._v("Dune V2：DatabricksSQL（Dune V2 终于开始跟上来了）")])]),s._v(" "),a("p",[s._v("为什么？ 我觉得有几点原因：")]),s._v(" "),a("ul",[a("li",[s._v("存储数据量大，像 BSC Solana 链底层数据有 TB 级别")]),s._v(" "),a("li",[s._v("数据湖方案无需运维，开箱即用")]),s._v(" "),a("li",[s._v("绝大部分指标，使用 SQL 就可以完成计算")])]),s._v(" "),a("h3",{attrs:{id:"抽象-abstractions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#抽象-abstractions"}},[s._v("#")]),s._v(" 抽象 Abstractions")]),s._v(" "),a("p",[s._v("Dune 对常用的指标做了整合，称为 Abstractions，Abstraction in DuneV2 will run on dbt (data build tool).")]),s._v(" "),a("p",[s._v("sql only 的模式下，使用 "),a("a",{attrs:{href:"https://www.getdbt.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("dbt"),a("OutboundLink")],1),s._v(" 是一个必然选择, sql 不像代码那样好管理，而 dbt 为 sql 提供了工程化的能力。")]),s._v(" "),a("h2",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("最后，总结一下，Dune V2 组件和实现方案：")]),s._v(" "),a("ul",[a("li",[s._v("链数据同步，chain --\x3e databricks sql：方案未知")]),s._v(" "),a("li",[s._v("event logs：方案未知")]),s._v(" "),a("li",[s._v("chain data 存储： databricks sql")]),s._v(" "),a("li",[s._v("计算引擎： databricks sql")]),s._v(" "),a("li",[s._v("query api： hasura")]),s._v(" "),a("li",[s._v("web ui: 方案未知")])]),s._v(" "),a("h2",{attrs:{id:"延伸话题-dune-为何选择-sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#延伸话题-dune-为何选择-sql"}},[s._v("#")]),s._v(" 延伸话题，Dune 为何选择 SQL？")]),s._v(" "),a("p",[s._v("以下纯粹是个人见解")]),s._v(" "),a("ul",[a("li",[s._v("sql 易上手, 更接近自然语言，适用人群广")]),s._v(" "),a("li",[s._v("业务架构简单，Dune 只需要准备好 chain 底层数据，例如 transactions token_transfers logs 等，还有解析好的 event 数据，以及 price 数据等，\n这些数据都是比较底层的，很容易保障数据质量，用户直接基于底层数据算出指标，没有中间表和复杂的调度流程，每次都是全量计算，用户有非常广阔的探索空间。")]),s._v(" "),a("li",[s._v("技术架构简单，使用异步查询+缓存，sql 的计算压力都压给 databricks sql，牺牲快速查询的体验，保证了大数据查询的能力")])]),s._v(" "),a("p",[s._v("坏处是什么？")]),s._v(" "),a("ul",[a("li",[s._v("sql 无法完成复杂的指标计算，或者稍微复杂的计算需要几百行 sql 才能完成")]),s._v(" "),a("li",[s._v("每次查询都是从底层数据算起，有大量的重复计算，浪费算力")])])])}),[],!1,null,null,null);a.default=e.exports}}]);