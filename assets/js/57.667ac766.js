(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{603:function(e,t,a){"use strict";a.r(t);var s=a(2),r=Object(s.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"基于-waterline-的简单事务处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于-waterline-的简单事务处理"}},[e._v("#")]),e._v(" 基于 waterline 的简单事务处理")]),e._v(" "),t("h1",{attrs:{id:"基于-waterline-的简单事务处理-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基于-waterline-的简单事务处理-2"}},[e._v("#")]),e._v(" 基于 waterline 的简单事务处理")]),e._v(" "),t("h2",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[e._v("#")]),e._v(" 安装")]),e._v(" "),t("p",[t("code",[e._v("$ npm install waterline-transact")])]),e._v(" "),t("h2",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[e._v("#")]),e._v(" 配置")]),e._v(" "),t("p",[e._v("需要配合 "),t("a",{attrs:{href:"http://sailsjs.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Sails.js"),t("OutboundLink")],1),e._v(" 使用")]),e._v(" "),t("p",[e._v("在 sails 的"),t("code",[e._v("./api/model")]),e._v(" 添加一个 Model")]),e._v(" "),t("p",[e._v("Transaction.js")]),e._v(" "),t("p",[e._v("module.exports = {")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("  attributes: {    //事务名    name: {type: 'string'},    //保存事务处理的一些消息，例如事务处理失败原因。    msg: {type: 'string'},    //事务状态 start,pending,finish,canceling,rollback...    state: {type: 'string'},    start_time: {type: 'date'},    end_time: {type: 'date'},    //事务操作的文档    /**     * {     * coll   操作的表     * act    动作  insert or update     * docId  操作的对象的id     * data   操作对象的数据     * pre    update操作时，对象在update之前的状态     * time   时间戳     * }     */    changes: {type: 'array'}  }};\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("这个 Model 用于保存事务的操作记录。")]),e._v(" "),t("p",[e._v("在 bootsstrap.js 里将 sails 对象传入")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("var Transact = require('waterline-transact');Transact.init(sails);\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h2",{attrs:{id:"使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[e._v("#")]),e._v(" 使用")]),e._v(" "),t("p",[e._v("这个库在封装了 waterline 的 create 和 update 方法，需要事务操作时，使用本库提供的 txCreate 和 txUpdate 方法来替代。这样就会自动记录本次操作，方便回滚。")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("var Transact = require('waterline-transact');Transact.transactionManager(\"正常事务\", function (transactionId, taskCallback) {  /**   * @User Model   * @transactionId 事务ID   * @user_data 本次create操作保存的数据   *    */  Transact.txCreate(User, transactionId, user_data, function (err, cUser) {    taskCallback(err, cUser);  });}, function (err, result) {  //do some thing})\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("h2",{attrs:{id:"测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[e._v("#")]),e._v(" 测试")]),e._v(" "),t("p",[e._v("需要在 sails 的"),t("code",[e._v("./api/model")]),e._v(" 添加一个 Model")]),e._v(" "),t("p",[e._v("User.js")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("module.exports = {  attributes: {    phone : { type: 'string', unique: true},    created_from: { type: 'string'},  }};\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("将 test 目录下的 WaterLineTransct.test.js 放入 sails 的测试目录中，启动 sails 的测试即可。")]),e._v(" "),t("h2",{attrs:{id:"dependencies"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dependencies"}},[e._v("#")]),e._v(" Dependencies")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://github.com/caolan/async",target:"_blank",rel:"noopener noreferrer"}},[e._v("Async.js"),t("OutboundLink")],1)])]),e._v(" "),t("h2",{attrs:{id:"license"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#license"}},[e._v("#")]),e._v(" License")]),e._v(" "),t("p",[t("a",{attrs:{href:"http://opensource.org/licenses/MIT",target:"_blank",rel:"noopener noreferrer"}},[e._v("The MIT License"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);