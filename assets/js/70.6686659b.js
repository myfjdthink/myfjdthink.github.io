(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{629:function(s,n,e){"use strict";e.r(n);var r=e(2),a=Object(r.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"class-extends-function"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#class-extends-function"}},[s._v("#")]),s._v(" class extends function")]),s._v(" "),n("p",[s._v("注意：本文示例代码是 typescript")]),s._v(" "),n("h2",{attrs:{id:"klg-logger-的封装"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#klg-logger-的封装"}},[s._v("#")]),s._v(" klg-logger 的封装")]),s._v(" "),n("p",[s._v("最近在做一个共用的 logger 包 "),n("a",{attrs:{href:"https://github.com/kaolalicai/klg-logger",target:"_blank",rel:"noopener noreferrer"}},[s._v("klg-logger"),n("OutboundLink")],1),s._v(" ，在调研了一圈后，决定基于 "),n("a",{attrs:{href:"https://github.com/baryon/tracer",target:"_blank",rel:"noopener noreferrer"}},[s._v("tracer"),n("OutboundLink")],1),s._v(" 这个包来做封装，tracer 足够简单，也具有拓展性。因为公司使用的工具包都是使用 class 风格的， 所以第一版的 klg-logger 长这样：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("import {console, Tracer} from 'tracer'\n\nexport class Logger {\n  private logger: any\n\n  constructor (config?: Tracer.LoggerConfig) {\n    this.logger = console(config)\n  }\n\n  log (msg: any, ...params): void {\n    this.logger.log.apply(this, arguments)\n  }\n\n  error (msg: any, ...params): void {\n    this.logger.error.apply(this, arguments)\n  }\n  // ...\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("使用方式：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const logger = new Logger({})\nlogger.log('hello world')\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("就是使用一个 Logger class 把 tracer 封装了一次。")]),s._v(" "),n("h2",{attrs:{id:"this-域问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#this-域问题"}},[s._v("#")]),s._v(" this 域问题")]),s._v(" "),n("p",[s._v("过了一段时间，klg-logger 出现了一个错误：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("TypeError: Cannot read property 'logger' of undefined\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("经排查，是 this 作用域的问题，调用 logger 的代码长这样：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("this.connect().then(function () {\n  // code\n}).catch(logger.error)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("logger.error 这个 function 是作为 参数直接传递个 catch， 那么 logger.error 内部的 this 将会指向 catch 对象，而不再是 logger 对象。")]),s._v(" "),n("p",[s._v("我们可以改变写法来避免这个错误：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("this.connect().then(function () {\n // empty\n}).catch(function (err) {\n  logger.error(err.message)\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("但如果要更彻底地解决这个问题，还是要改变一下 logger.error 的实现才行。")]),s._v(" "),n("h2",{attrs:{id:"class-extends-function-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#class-extends-function-2"}},[s._v("#")]),s._v(" class extends function")]),s._v(" "),n("p",[s._v("考虑到这个包 klg-logger 已经在多个系统中使用，为了保持兼容，我们要继续保持 class 风格，所以我们要把上文提到的“封装”的实现改为继承实现。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("import {console} from 'tracer'\n\nexport class Logger extends console {\n  // Error:(3, 29) TS2507: Type '(config?: LoggerConfig) => Logger' is not a constructor function type.\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("直接继承 tracer 的 console 是会报错的，因为 console function 没有 construction。")]),s._v(" "),n("p",[s._v("在 stackoverflow 上可以找到解决方案："),n("a",{attrs:{href:"https://stackoverflow.com/questions/36871299/how-to-extend-function-with-es6-classes",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://stackoverflow.com/questions/36871299/how-to-extend-function-with-es6-classes"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("通过一个 Function 把 console 包装成一个具有 construction 的对象，然后在 construction 里面 return console 实例即可")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("class Logger extends Function implements Tracer.Logger {\n  constructor (config?: LoggerConfig) {\n    super()\n    Object.setPrototypeOf(console, Logger.prototype)\n    const instance = console(config as any) as Logger\n    instance.err = instance.error\n    return instance\n  }\n\n  // 下列方法都会被覆盖，只做声明用， 无需实现\n  debug (...args: any[]): Tracer.LogOutput {\n    return undefined\n  }\n\n  error (...args: any[]): Tracer.LogOutput {\n    return undefined\n  }\n\n  /// ......\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("经测试，最后的写法和功能都是原版保持了一致。")])])}),[],!1,null,null,null);n.default=a.exports}}]);